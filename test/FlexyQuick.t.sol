// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "../src/Flexy.sol";
import "ds-test/test.sol";
import "forge-std/Script.sol";

// import "openzeppelin-contracts/contracts/token/ERC20/ERC20.sol";

contract FlexyQuick is DSTest, Script {
    Flexy flexy;
    IERC20 usdce = IERC20(0x1B6382DBDEa11d97f24495C9A90b7c88469134a4);
    address relayer = 0x757EEB3E60d0D3f9a8a34A8540AB6c88eB058e49;

    function setUp() external {
        string
            memory rpc = "https://rpc.ankr.com/scroll/eb48a33ddd90d1a05df0c6599854b3fa3ad93ca7daa46622a4291faacf73a904";
        uint256 forkId = vm.createFork(rpc);
        vm.selectFork(forkId);

        flexy = Flexy(payable(0x6025381636614b10a13A91B64C74c1176870Ac67));
        // g = new GasBot(relayer, relayer);
        console.log("Flexy address: %s", address(flexy));
    }

    // ============================
    // Test Implementation Update
    // ============================
    function test_getTokenBalances() external {
        address[] memory tokens = new address[](1);
        tokens[0] = address(usdce);
        flexy.getTokenBalancesAndPermit2Allowances(relayer, tokens);
    }

    // function test_relayAndTransfer() external {
    //     //         function relayAndTransfer(
    //     //         address _sender,
    //     //         address _token,
    //     //         uint256 _amount,
    //     //         bytes calldata _permitData,
    //     //         address _target,
    //     //         bytes calldata _data,
    //     //         uint256 _sendAmount,
    //     //         address _weth
    //     //     )

    //     // ['0xe2b8e07b913af9ED2b13808e48F2303964276651', '0xdAC17F958D2ee523a2206206994597C13D831ec7', 100000, '0x70a08231000000000000000000000000e2b8e07b913af9ed2b13808e48f2303964276651', '0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45', '0x04e45aaf000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000001f400000000000000000000000059af55fe00ccc0f0c248510fcc774fdc4919bbbf000000000000000000000000000000000000000000000000000000000000c35000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000000', 100, '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2'
    //     //

    //     vm.startPrank(relayer);
    //     g.relayAndTransfer(
    //         0xe2b8e07b913af9ED2b13808e48F2303964276651,
    //         0xdAC17F958D2ee523a2206206994597C13D831ec7,
    //         1000000,
    //         hex"70a08231000000000000000000000000e2b8e07b913af9ed2b13808e48f2303964276651",
    //         0x68b3465833fb72A70ecDF485E0e4C7bD8665Fc45,
    //         hex"04e45aaf000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000001f400000000000000000000000059af55fe00ccc0f0c248510fcc774fdc4919bbbf000000000000000000000000000000000000000000000000000000000007a12000000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000000",
    //         1,
    //         0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
    //     );
    //     vm.stopPrank();
    //     // assert(address(0xe2b8e07b913af9ED2b13808e48F2303964276651).balance > 0);
    //     // assertEq(address(g).balance, 0);
    // }

    function test_relayIn() external {
        // function relayIn(
        //     address _token,
        //     PermitParams calldata _permitData,
        //     Permit2Params calldata _permit2Data,
        //     address _customRouter,
        //     bytes calldata _swapData,
        //     uint256 _minAmountOut,
        //     uint256 _deadline
        // )

        // ['0x82f0B8B456c1A451378467398982d4834b6829c1', ('0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e', '0x0b19E4C6E95C49ab00d925C716eD1a1cB7D9E675', 1000000000000000000, 1717436110, 27, HexBytes('0xfb16b886a082f0823055452a15298660096634e616350b290925034dba99e394'), HexBytes('0x475033a12249add0c9ca283c207708e9a8fc393f72a38863b727323b5a0a6997')), ((['0x0000000000000000000000000000000000000000', 0], 0, 0), HexBytes('0x00')), '0xF491e7B69E4244ad4002BC14e878a34207E38c29', '0x38ed17390000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000f1b3000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000b19e4c6e95c49ab00d925c716ed1a1cb7d9e67500000000000000000000000000000000000000000000000000000000665dfedc000000000000000000000000000000000000000000000000000000000000000200000000000000000000000082f0b8b456c1a451378467398982d4834b6829c10000000000000000000000001b6382dbdea11d97f24495c9a90b7c88469134a4', 990000, 1717436124]

        Flexy.PermitParams memory permitParams = Flexy.PermitParams(
            0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e,
            0x0b19E4C6E95C49ab00d925C716eD1a1cB7D9E675,
            1000000000000000000,
            1717436110,
            27,
            hex"fb16b886a082f0823055452a15298660096634e616350b290925034dba99e394",
            hex"475033a12249add0c9ca283c207708e9a8fc393f72a38863b727323b5a0a6997"
        );

        ISignatureTransfer.TokenPermissions
            memory tokenPermissions = ISignatureTransfer.TokenPermissions(
                address(0),
                0
            );
        ISignatureTransfer.PermitTransferFrom
            memory permitTransferFrom = ISignatureTransfer.PermitTransferFrom(
                tokenPermissions,
                0,
                0
            );
        Flexy.Permit2Params memory permit2Params = Flexy.Permit2Params(
            permitTransferFrom,
            hex"00"
        );

        vm.startPrank(relayer);
        flexy.relayIn(
            0x82f0B8B456c1A451378467398982d4834b6829c1,
            permitParams,
            permit2Params,
            0xF491e7B69E4244ad4002BC14e878a34207E38c29,
            hex"38ed17390000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000f1b3000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000b19e4c6e95c49ab00d925c716ed1a1cb7d9e67500000000000000000000000000000000000000000000000000000000665dfedc000000000000000000000000000000000000000000000000000000000000000200000000000000000000000082f0b8b456c1a451378467398982d4834b6829c10000000000000000000000001b6382dbdea11d97f24495c9a90b7c88469134a4",
            990000,
            1717436124
        );
        vm.stopPrank();
        assert(address(0xe2b8e07b913af9ED2b13808e48F2303964276651).balance > 0);
        // assertEq(address(g).balance, 0);
    }

    function test_transferOut() external {
        // function transferOut(
        //     address _outputToken,
        //     address _recipient,
        //     address _customRouter,
        //     bytes calldata _swapData,
        //     uint256 _swapAmount,
        //     uint256 _minAmountOut,
        //     uint256 outbound_id,
        //     uint256 _gasLimit,
        //     uint256 _deadline
        // )

        // ['0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359', '0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e', '0xE592427A0AEce92De3Edee1F18E0157C05861564', '0xc04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000b19e4c6e95c49ab00d925c716ed1a1cb7d9e67500000000000000000000000000000000000000000000000000000000665e076b00000000000000000000000000000000000000000000000000000000000a60400000000000000000000000000000000000000000000000000cdc900af111600000000000000000000000000000000000000000000000000000000000000000422791bca1f2de4661ed88a30c99a7a9449aa841740001f40d500b1d8e8ef31e21c99d1db9a6444d3adf12700001f43c499c542cef5e3811e1192ce70d8cc03d5c3359000000000000000000000000000000000000000000000000000000000000', 680000, 926774000000000000, 1224, 30000, 1717438315]
        // ['0x82f0B8B456c1A451378467398982d4834b6829c1', '0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e', '0xF491e7B69E4244ad4002BC14e878a34207E38c29', '0x38ed173900000000000000000000000000000000000000000000000000000000000a60400000000000000000000000000000000000000000000000000b25d115c5e2e00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000b19e4c6e95c49ab00d925c716ed1a1cb7d9e67500000000000000000000000000000000000000000000000000000000665e0a2700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001b6382dbdea11d97f24495c9a90b7c88469134a400000000000000000000000021be370d5312f44cb42ce377bc9b8a0cef1a4c8300000000000000000000000082f0b8b456c1a451378467398982d4834b6829c1', 680000, 803278000000000000, 1225, 30000, 1717439015]
        // ['0x0000000000000000000000000000000000000000', '0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e', '0x18b71386418A9FCa5Ae7165E31c385a5130011b6', '0x38ed1739000000000000000000000000000000000000000000000000000000000025896000000000000000000000000000000000000000000000267698de1f85d7ed231a00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000006025381636614b10a13a91b64c74c1176870ac670000000000000000000000000000000000000000000000000000000066671f1d000000000000000000000000000000000000000000000000000000000000000200000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a40000000000000000000000005300000000000000000000000000000000000004', 2460000, 181637657426142553776922, 1268, 30000, 1718034205]

        vm.startPrank(relayer);
        flexy.transferOut(
            0x0000000000000000000000000000000000000000,
            0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e,
            0x18b71386418A9FCa5Ae7165E31c385a5130011b6,
            hex"38ed1739000000000000000000000000000000000000000000000000000000000025896000000000000000000000000000000000000000000000267698de1f85d7ed231a00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000006025381636614b10a13a91b64c74c1176870ac670000000000000000000000000000000000000000000000000000000066671f1d000000000000000000000000000000000000000000000000000000000000000200000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a40000000000000000000000005300000000000000000000000000000000000004",
            2460000,
            181637657426142553776922,
            1268,
            30000,
            1718034205
        );

        // flexy.transferOut(
        //     0x82f0B8B456c1A451378467398982d4834b6829c1,
        //     0x1B7FE02Da6c7a7175a33D109397492c2872c6A5e,
        //     0xF491e7B69E4244ad4002BC14e878a34207E38c29,
        //     hex"38ed173900000000000000000000000000000000000000000000000000000000000a60400000000000000000000000000000000000000000000000000b25d115c5e2e00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000b19e4c6e95c49ab00d925c716ed1a1cb7d9e67500000000000000000000000000000000000000000000000000000000665e0a2700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001b6382dbdea11d97f24495c9a90b7c88469134a400000000000000000000000021be370d5312f44cb42ce377bc9b8a0cef1a4c8300000000000000000000000082f0b8b456c1a451378467398982d4834b6829c1",
        //     680000,
        //     803278000000000000,
        //     1225,
        //     30000,
        //     1717439015
        // );
        vm.stopPrank();
        assert(address(0xe2b8e07b913af9ED2b13808e48F2303964276651).balance > 0);
        // assertEq(address(g).balance, 0);
    }
}
